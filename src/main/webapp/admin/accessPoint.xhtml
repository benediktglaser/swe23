<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3c.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/main.xhtml">



    <ui:define name="content">
        <form id="downloadForm" method="get">
        </form>
        <h:form id="accessPointForm">

            <p:poll interval="6" update="accessPointTable"/>
            <p:dataTable id="accessPointTable" var="accessPoint" value="#{accessPointController}" lazy="true" rows="3"
                         paginator="true" scrollable="true" scrollHeight="400">
                <p:column headerText="UUID" sortBy="#{accessPoint.id}" filterBy="#{accessPoint.id}">
                    <h:outputText value="#{accessPoint.id}"/>
                </p:column>
                <p:column headerText="AccessPoint name" sortBy="#{accessPoint.accessPointName}"
                          filterBy="#{accessPoint.accessPointName}">
                    <h:outputText value="#{accessPoint.accessPointName}"/>
                </p:column>
                <p:column headerText="connected" sortBy="#{accessPoint.connected}" filterBy="#{accessPoint.connected}">
                    <h:selectBooleanCheckbox value="#{accessPoint.connected}" disabled="true"/>
                </p:column>
                <p:column headerText="Enabled" sortBy="#{accessPoint.enabled}" filterBy="#{accessPoint.enabled}">
                    <h:selectBooleanCheckbox value="#{accessPoint.enabled}" disabled="#{accessPoint.enabled}">
                        <p:ajax update="accessPointTable"
                                listener="#{accessPointDetailController.doSaveAccessPoint(accessPoint)}"/>
                    </h:selectBooleanCheckbox>
                </p:column>

                <p:column style="text-align: center">
                    <p:commandButton update=":accessPointForm:accessPointEditDialog"
                                     oncomplete="PF('accessPointEditDialog').show()" icon="pi pi-pencil" title="Edit">
                        <f:setPropertyActionListener value="#{accessPoint}"
                                                     target="#{accessPointDetailController.accessPoint}"/>
                    </p:commandButton>
                    <p:commandButton action="#{accessPointDetailController.doDeleteAccessPoint}" icon="pi pi-trash"
                                     title="Delete" update=":accessPointForm:accessPointTable">
                        <f:setPropertyActionListener value="#{accessPoint}"
                                                     target="#{accessPointDetailController.accessPoint}"/>
                        <p:confirm header="Confirmation"
                                   message="Are you sure that you want to delete this AccessPoint? You cannot undo this operation."
                                   icon="ui-icon-alert"/>
                    </p:commandButton>
                </p:column>
                <p:column style="text-align: center">
                    <p:commandButton title="SensorStations" value="SensorStations"
                                     update=":accessPointForm:accessPointLinkDialog"
                                     action="#{sensorStationListController.filterSensorStationsByAccessPoint(accessPoint)}"
                                     oncomplete="PF('accessPointLinkDialog').show()"

                    />
                </p:column>
            </p:dataTable>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" width="300">
                <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check"/>
                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="pi pi-times"/>
            </p:confirmDialog>

            <p:dialog header="Link AccessPoint" id="accessPointLinkDialog" widgetVar="accessPointLinkDialog"
                      modal="true" showEffect="fade" hideEffect="fade" resizable="false" dynamic="true" scrollHeight="400">
                <p:outputPanel id="accessPointLinkData">
                    <p:commandButton value="Activate Couplemode"
                                     actionListener="#{accessPointCoupleController.startCouplingMode(sensorStationListController.accessPoint)}"
                                     onstart="startTimer()">
                    </p:commandButton>

                    <p:dataTable id="connectTable" value="#{sensorStationListController}" var="sensorStation"
                                 lazy="true" rows="5" paginator="true" scrollable="true" scrollHeight="300">
                        <p:column headerText="UUID" sortBy="#{sensorStation.id}" filterBy="#{sensorStation.id}">
                            <h:outputText value="#{sensorStation.id}"/>
                        </p:column>
                        <p:column headerText="DIP Id" sortBy="#{sensorStation.dipId}" filterBy="#{sensorStation.dipId}">
                            <h:outputText value="#{sensorStation.dipId}"/>
                        </p:column>
                        <p:column headerText="Plant Name" sortBy="#{sensorStation.name}"
                                  filterBy="#{sensorStation.name}">
                            <h:outputText value="#{sensorStation.name}"/>
                        </p:column>
                        <p:column headerText="Plant Category" sortBy="#{sensorStation.category}"
                                  filterBy="#{sensorStation.category}">
                            <h:outputText value="#{sensorStation.category}"/>
                        </p:column>
                        <p:column headerText="Create Date" sortBy="#{sensorStation.createDate}"
                                  filterBy="#{sensorStation.createDate}">
                            <h:outputText value="#{sensorStation.createDate}"/>
                        </p:column>
                        <p:column headerText="Gardener" sortBy="#{sensorStation.gardener}"
                                  filterBy="#{sensorStation.gardener}">
                            <h:outputText value="#{sensorStation.gardener}"/>
                        </p:column>
                        <p:column headerText="Enabled" sortBy="#{sensorStation.enabled}"
                                  filterBy="#{sensorStation.enabled}">
                            <h:selectBooleanCheckbox value="#{sensorStation.enabled}" disabled="false">
                                <p:ajax update="connectTable"
                                        listener="#{sensorStationDetailController.saveSensorStation(sensorStation)}"/>
                            </h:selectBooleanCheckbox>
                        </p:column>
                        <p:column style="width:5%;text-align: center">
                            <p:commandButton title="Assign gardener" value="Assign"
                                             action="#{gardenerSensorStationController.setSensorStation(sensorStation)}"
                                             update=":accessPointForm:assignDialog"
                                             oncomplete="PF('assignDialog').show()"/>
                        </p:column>
                        <p:column style="width:7%;text-align: center">
                            <p:commandButton update=":accessPointForm" value="MinMaxEdit"
                                             action="#{sensorStationDetailController.redirectToMinMaxEdit(sensorStation)}"/>
                        </p:column>
                        <p:column style="width:2%;text-align: center">
                            <p:commandButton id="edit" icon="pi pi-pencil"
                                             update=":accessPointForm:sensorStationFormEditDialog"
                                             oncomplete="PF('sensorStationFormEditDialog').show()"
                                             action="#{sensorStationDetailController.setSensorStation(sensorStation)}"
                            />
                        </p:column>
                        <p:column style="width:7%;text-align: center">
                            <p:commandButton id="sensordata" value="Sensordata"
                                             action="#{sensorStationListController.redirectToSensorDataPage(sensorStation)}"/>
                        </p:column>
                        <p:column>
                        <p:commandButton id="gallery" value="Gallery"
                                         action="#{sensorStationListController.redirectToGallery(sensorStation)}"/>
                        </p:column>
                        <p:column style="width:10%;text-align: center">
                            <p:commandButton id="download" value="DownloadQRCode"
                                             action="#{QRCodeDownloadController.doUpdate(sensorStation.id)}"/>
                        </p:column>
                    </p:dataTable>
                </p:outputPanel>
            </p:dialog>
            <script>
                function sent(param) {
                    const sensorLink = "http://localhost:8080/visitor/sensorStations/gallery.xhtml";
                    const sensorUrl = sensorLink + param;
                    document.getElementById("downloadForm").setAttribute("action", sensorUrl);
                    document.getElementById("downloadForm").submit();
                }
            </script>
            <p:dialog header="Sensor Station Details" id="sensorStationFormEditDialog"
                      widgetVar="sensorStationFormEditDialog" modal="true" showEffect="fade" hideEffect="fade"
                      resizable="false" dynamic="true">
                <p:defaultCommand target="saveButtonEdit"/>
                <h:panelGrid columns="2">
                    <p:outputLabel for="plant_name" value="Plant Name: "/>
                    <p:inputText id="plant_name" value="#{sensorStationDetailController.sensorStation.name}"/>
                    <p:outputLabel for="plant_category" value="Plant Category: "/>
                    <p:inputText id="plant_category" value="#{sensorStationDetailController.sensorStation.category}">
                    </p:inputText>
                    <p:outputLabel for="plant_interval"
                                   value="Interval(includes overhead #{sensorStationDetailController.sensorStation.accessPoint.thresholdInterval}): "/>
                    <p:inputText id="plant_interval"
                                 value="#{sensorStationDetailController.sensorStation.accessPoint.sendingInterval}">
                    </p:inputText>
                </h:panelGrid>
                <p:commandButton id="saveButtonEdit" value="Save"
                                 update="accessPointLinkData"
                                 action="#{sensorStationDetailController.saveSensorStation(sensorStationDetailController.sensorStation)}"
                                 oncomplete="PF('sensorStationFormEditDialog').hide()"
                />
            </p:dialog>
            <p:dialog header="Assign a gardener" widgetVar="assignDialog" id="assignDialog" modal="true"
                      draggable="false" closable="true" resizable="false" dynamic="true">

                <p:outputPanel id="assignPanel">
                    <p:messages id="validMsg"/>
                    <p:defaultCommand target="assignButton"/>
                    <p:autoComplete id="event" value="#{gardenerSensorStationController.username}"
                                    completeMethod="#{userListController.getAllUsername}" scrollHeight="250"/>
                    <p:commandButton id="assignButton" value="SUBMIT"
                                     action="#{gardenerSensorStationController.assignSensorStationToGardener(gardenerSensorStationController.sensorStation)}"
                                     update="connectTable assignPanel validMsg">
                    </p:commandButton>
                </p:outputPanel>
                <script>
                    function isValid(param) {

                        if (param === 'true') {
                            PF('assignDialog').hide()
                        } else {
                            PF('assignDialog').show()
                        }
                    }
                </script>
            </p:dialog>
            <p:dialog widgetVar="spinner" modal="true" draggable="false" closable="false" resizable="false" dynamic="true">
                <i class="pi pi-spin pi-spinner" style="font-size: 1rem"></i>
                <p:messages id="connectMsg"/>
                <p:outputPanel id="aviableData">
                    <p:poll interval="5" update="aviableData"/>
                    <p:dataTable id="avaiableTable"
                                 value="#{visibleSensorStationController.getSensorStationsByAccessPoint(sensorStationListController.accessPoint)}"
                                 var="dipIds"
                                 lazy="true" rows="3" paginator="true" scrollable="true" scrollHeight="400">
                        <p:column headerText="DIP Id"
                                  filterBy="#{visibleSensorStationController.getSensorStationsByAccessPointAndDipId(sensorStationListController.accessPoint,dipIds).dipId}">
                            <h:outputText
                                    value="#{visibleSensorStationController.getSensorStationsByAccessPointAndDipId(sensorStationListController.accessPoint,dipIds).dipId}"/>
                        </p:column>
                        <p:column headerText="MAC"
                                  filterBy="#{visibleSensorStationController.getSensorStationsByAccessPointAndDipId(sensorStationListController.accessPoint,dipIds).mac}">
                            <h:outputText
                                    value="#{visibleSensorStationController.getSensorStationsByAccessPointAndDipId(sensorStationListController.accessPoint,dipIds).mac}"/>
                        </p:column>
                        <p:column headerText="Connected"
                                  filterBy="#{visibleSensorStationController.getSensorStationsByAccessPointAndDipId(sensorStationListController.accessPoint,dipIds).getConnected()}">
                            <h:outputText
                                    value="#{visibleSensorStationController.getSensorStationsByAccessPointAndDipId(sensorStationListController.accessPoint,dipIds).getConnected()}"/>
                        </p:column>
                        <p:column headerText="Connect">
                            <p:commandButton icon="pi pi-link"
                                             action="#{visibleSensorStationController.selectSensorStation(sensorStationListController.accessPoint,dipIds)}"
                                             onstart="PF('statusDialog').show()">

                            </p:commandButton>
                        </p:column>
                    </p:dataTable>
                    <p:commandButton value="Deactivate Couplemode"
                                     actionListener="#{accessPointCoupleController.endCouplingMode(sensorStationListController.accessPoint)}"
                                     action="#{visibleSensorStationController.resetVisibleList(sensorStationListController.accessPoint)}"
                                     oncomplete="endCoupleMode()" update="accessPointLinkData">
                    </p:commandButton>

                </p:outputPanel>
            </p:dialog>
            <p:dialog widgetVar="statusDialog" onShow="startTimer1();" modal="true" draggable="false"
                      resizable="false" showHeader="false" closable="false" onHide="stopPoll();">
                <h:outputText value="Connecting" style="margin-left:10px;"/>
                <i class="pi pi-spin pi-spinner" style="font-size: 0.8rem"/>
                <p:poll id="connectPoll" interval="5"
                        listener="#{accessPointCoupleController.connectHandler(visibleSensorStationController.selectedDipId)}"
                        update="aviableData connectMsg"/>

            </p:dialog>
            <script>
                var timer;
                function startTimer1() {
                    timer = setTimeout(function () {
                        if (!PF('statusDialog').isVisible()) {
                        } else {
                            alert("Connecting reached timeout");
                            PF('statusDialog').hide();
                        }
                    }, 30000); // 30 sec in milliseconds
                }

                function stopPoll() {
                    PF('connectPoll').stop();
                }
            </script>

            <script>
                var timer;

                function startTimer() {
                    PF('spinner').show();
                    timer = setTimeout(function () {
                        if (!PF('spinner').isVisible()) {

                        } else {
                            alert("Coupling reached timeout");
                            PF('spinner').hide();
                        }


                    }, 300000); // 5 minutes in milliseconds
                }
            </script>
            <script>
                function endCoupleMode() {

                    PF('spinner').hide();

                }
            </script>
            <script>
                function updateTable() {
                    PF('ConnectTable').loadLazyData();
                }

                setInterval(updateTable, 10000); // 10 seconds
            </script>
            <p:dialog header="Edit AccessPoint" id="accessPointEditDialog" widgetVar="accessPointEditDialog"
                      modal="true" showEffect="fade" hideEffect="fade" resizable="false" dynamic="true">
                <p:outputPanel id="accessPointData" rendered="#{not empty accessPointDetailController.accessPoint}">
                    <p:panelGrid columns="2">
                        <p:outputLabel for="UUID" value="UUID: "/>
                        <p:inputText id="UUID" value="#{accessPointDetailController.accessPoint.id}" disabled="true"/>

                        <p:outputLabel for="accessPointName" value="AccessPoint Name: "/>
                        <p:inputText id="accessPointName"
                                     value="#{accessPointDetailController.accessPoint.accessPointName}"/>

                        <p:outputLabel for="accessPointThresholdInterval" value="Threshold Interval: "/>
                        <p:inputText id="accessPointThresholdInterval"
                                     value="#{accessPointDetailController.accessPoint.thresholdInterval}"/>

                        <p:outputLabel for="enabled" value="Enabled: "/>
                        <p:selectBooleanCheckbox id="enabled"
                                                 value="#{accessPointDetailController.accessPoint.enabled}"/>
                    </p:panelGrid>
                    <p:commandButton value="Save" action="#{accessPointDetailController.doSaveAccessPoint()}"
                                     oncomplete="PF('accessPointEditDialog').hide()"
                                     update=":accessPointForm:accessPointTable"/>
                </p:outputPanel>
            </p:dialog>

        </h:form>
    </ui:define>

</ui:composition>
